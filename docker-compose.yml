version: '3.8'

networks:
  jenkins-network:
    driver: bridge

volumes:
  jenkins-master-data:
  jenkins-slave-data:
  gitlab-config:
  gitlab-logs:
  gitlab-data:
  gitea-data:
  sonarqube-data:
  sonarqube-extensions:
  sonarqube-logs:
  postgresql-data:

services:
  # Jenkins Master
  jenkins-master:
    image: jenkins/jenkins:lts
    container_name: jenkins-master
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "50000:50000"
    volumes:
      - jenkins-master-data:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - JENKINS_OPTS=--prefix=/jenkins
    networks:
      - jenkins-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/login || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Jenkins Slave (Agent)
  jenkins-slave:
    build:
      context: ./jenkins-slave
      dockerfile: Dockerfile
    container_name: jenkins-slave
    restart: unless-stopped
    user: root # Nécessaire pour certaines opérations Docker /!\ Sécurité
    volumes:
      - jenkins-slave-data:/home/jenkins
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - JENKINS_MASTER=http://jenkins-master:8080/jenkins
      - JENKINS_URL=http://jenkins-master:8080/jenkins
      - JENKINS_AGENT_NAME=docker-agent
      - JENKINS_SECRET=da0cda4c83e942a18fcfdc206b9aa400771f963bd5cbc6ab4706d8c763241e21
      - JENKINS_AGENT_WORKDIR=/home/jenkins
    networks:
      - jenkins-network
    depends_on:
      - jenkins-master

  # Serveur Staging (Debian avec Docker)
  staging-server:
    build:
      context: ./staging-server
      dockerfile: Dockerfile
    container_name: staging-server
    restart: unless-stopped
    ports:
      - "8081:80"
      - "8082:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - jenkins-network
    command: tail -f /dev/null

  # GitLab
  gitlab:
    profiles: ["gitlab"]
    image: gitlab/gitlab-ce:latest
    container_name: gitlab
    restart: unless-stopped
    hostname: gitlab
    ports:
      - "8090:80"
      - "8443:443"
      - "2222:22"
    volumes:
      - gitlab-config:/etc/gitlab
      - gitlab-logs:/var/log/gitlab
      - gitlab-data:/var/opt/gitlab
    environment:
      GITLAB_OMNIBUS_CONFIG: |
        external_url 'http://gitlab'
        gitlab_rails['gitlab_shell_ssh_port'] = 2222
        gitlab_rails['initial_root_password'] = 'rootpassword123'
        # Désactiver certains services pour réduire la consommation de ressources
        prometheus_monitoring['enable'] = false
        alertmanager['enable'] = false
    networks:
      - jenkins-network
    shm_size: '256m'
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost/-/health || exit 1"]
      interval: 60s
      timeout: 30s
      retries: 10
      start_period: 180s

  # Gitea (lightweight alternative to GitLab)
  gitea:
    profiles: ["gitea"]
    image: gitea/gitea:latest
    container_name: gitea
    restart: unless-stopped
    hostname: gitea
    ports:
      - "8090:3000"
      - "2222:22"
    volumes:
      - gitea-data:/data
    environment:
      - USER_UID=1000
      - USER_GID=1000
      - GITEA__database__DB_TYPE=sqlite3
      - GITEA__security__INSTALL_LOCK=true
      - GITEA__security__SECRET_KEY=changeme123456789
      - GITEA__server__ROOT_URL=http://localhost:8090
      - GITEA__webhook__ALLOWED_HOST_LIST=jenkins-master
      - GITEA__webhook__SKIP_TLS_VERIFY=true
    networks:
      - jenkins-network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # PostgreSQL pour SonarQube
  postgresql:
    image: postgres:13
    container_name: sonarqube-postgresql
    restart: unless-stopped
    environment:
      - POSTGRES_USER=sonar
      - POSTGRES_PASSWORD=sonarpassword
      - POSTGRES_DB=sonarqube
    volumes:
      - postgresql-data:/var/lib/postgresql/data
    networks:
      - jenkins-network

  # SonarQube
  sonarqube:
    image: sonarqube:lts-community
    container_name: sonarqube
    restart: unless-stopped
    ports:
      - "9000:9000"
    environment:
      - SONAR_JDBC_URL=jdbc:postgresql://postgresql:5432/sonarqube
      - SONAR_JDBC_USERNAME=sonar
      - SONAR_JDBC_PASSWORD=sonarpassword
    volumes:
      - sonarqube-data:/opt/sonarqube/data
      - sonarqube-extensions:/opt/sonarqube/extensions
      - sonarqube-logs:/opt/sonarqube/logs
    networks:
      - jenkins-network
    depends_on:
      - postgresql
    healthcheck:
      test: ["CMD-SHELL", "wget -q -O /dev/null http://localhost:9000/api/system/status || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
